name: CI/CD

on:
	push:
		branches: [ main ]
	pull_request:
		branches: [ main ]
		
	jobs:
		build:
			runs-on: ubuntu-latest
			
			steps:
			- uses: actions/checkout@v3
			
			- name: Set up Python
			  uses: actions/setup-python@v4
			  with:
				python-version: "3.10"
				
			- name: Install dependencies
			  run: |
				pip install -r app/requirements.txt
				pip install pytest

			- name: Run tests
			  run: pytest

			- name: Build Docker image
			  run: docker build -t ghcr.io/${{ github.repository }}/ml-api:${{ github.sha }} .

			- name: Log in to GitHub Container Registry
			  uses: docker/login-action@v2
			  with:
				registry: ghcr.io
				username: ${{ github.actor }}
				password: ${{ secrets.GITHUB_TOKEN }}

			- name: Push Docker image
			  run: docker push ghcr.io/${{ github.repository }}/ml-api:${{ github.sha }}	